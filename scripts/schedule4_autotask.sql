!set variable_substitution=true;
use database &{db_name};
use schema &{sc_name};
--
-- Create root task with a schedule
--CREATE OR REPLACE TASK SELLSIDE_ACCOUNT_DATA_AVAILABILITY_DETECT_HOURLY
--    WAREHOUSE = S1_BI
--    SCHEDULE = 'USING CRON 30 8-18 * * * America/Los_Angeles'
--AS
--UPDATE DATA_AGGREGATION_SOURCES 
--SET DATA_AVAILABLETIME = DATEADD('QUARTER', -1, DATE_TRUNC('QUARTER', CURRENT_DATE())) -1
--WHERE TARGET_TABLE = 'BI._TABLE_LOADING.SELLSIDE_ACCOUNT_DATA_DAILY_LOADING';
----
---- Create follower task with "after" cause
--CREATE  OR REPLACE TASK SELLSIDE_ACCOUNT_DATA_SUMMARY_POPULATE_HOURLY
--  WAREHOUSE = S1_BI
--  AFTER SELLSIDE_ACCOUNT_DATA_AVAILABILITY_DETECT_HOURLY
--AS
--CALL DATA_AGGREGATOR ('BI._TABLE_LOADING.SELLSIDE_ACCOUNT_DATA_DAILY_LOADING', 0);
----
---- Create follower task with "after" cause
--CREATE  OR REPLACE TASK SELLSIDE_ACCOUNT_DATA_SUMMARY_PUBLISH_HOURLY
--  WAREHOUSE = S1_BI
--  AFTER SELLSIDE_ACCOUNT_DATA_SUMMARY_POPULATE_HOURLY
--AS
--ALTER TABLE IF EXISTS BI.ACCOUNT_DATA.SELLSIDE_ACCOUNT_DATA_DAILY
--SWAP WITH BI._TABLE_LOADING.SELLSIDE_ACCOUNT_DATA_DAILY_LOADING;
----
---- Enable the root taks for hourly scheduled
--SELECT SYSTEM$TASK_DEPENDENTS_ENABLE('SELLSIDE_ACCOUNT_DATA_AVAILABILITY_DETECT_HOURLY');
--SHOW tasks;
